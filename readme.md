# MSA_CHAT

#### 기술 스택

카프카

스프링 부트

- stomp

스프링 클라우드

- 유레카

- 스프링클라우드 게이트웨이

- 스프링 클라우드 로드밸런서

레디스

도커

#### 아키텍쳐

채팅 3개

로그인은 같은 컨슈머 그룹

채팅은 모두 다른 컨슈머 그룹

게이트웨이
로드밸런서 

유레카 

#### 

#### 기능

1. 게이트웨이
   
   - url 값을 토대로 웹소켓 서비스와 메세지 서비스로 라우팅

2. 로드밸런서
   
   - 각 채팅 서버의 남은 램 용량으로 로드 밸런싱
   
   - 5초마다 카프카로 로드밸런서로 각 서버의 램 정보 전달
   
   - 각 램 정보로 각 웹소켓 서버의 가중치 조절
     
     - 웹소켓 서버에서 최소 연결 라우팅이 IO를 균등하게 나눌수 없을것 같아 가용 램으로 라우팅
   
   - spring cloud loadBalancer는 webflux 기반이여서 비동기 처리됨!

3. 웹소켓 서버
   
   - 웹소켓연결 이벤트로 헤더에서 유저 정보를 받아 redis에 session id, user id,  어떤 웹소켓 서버에 연결 되었는지 저장
   
   - 소켓연결 끊어지면 session id로 누가 나갔는지 확인
   
   - 한 유저가 여러 클라이언트에서 접속 방지
     
     - `preSend` 메소드는 메시지가 실제로 채널을 통해 전송되기 전에 호출되는 `ChannelInterceptor` 인터페이스의 메소드입니다. 이 메소드에서 메시지를 조작하거나, 특정 조건을 만족하지 않는 경우 메시지를 필터링할 수 있습니다. `preSend` 메소드가 `null`을 반환하면 해당 메시지는 전송되지 않으며, WebSocket 연결이 끊어집니다.
   
   - 로드밸런서로 서비스 이름과 가용 램 정보 전달

4. 메세지 서버
   
   - 금칙어 
     
     - trie를 사용해서 체크
